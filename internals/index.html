<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Internals - The Gobba Programming Language Handbook</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "light" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="expanded "><a href="../install.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="expanded "><a href="../basics/index.html"><strong aria-hidden="true">3.</strong> The Basics</a></li><li><ol class="section"><li class="expanded "><a href="../basics/purity.html"><strong aria-hidden="true">3.1.</strong> Purity and IO</a></li></ol></li><li class="expanded "><a href="../stdlib/stdlib.html"><strong aria-hidden="true">4.</strong> The Standard Library</a></li><li class="expanded "><a href="../ocaml.html"><strong aria-hidden="true">5.</strong> Calling Gobba from OCaml</a></li><li class="expanded "><a href="../internals/index.html" class="active"><strong aria-hidden="true">6.</strong> Internals</a></li><li><ol class="section"><li class="expanded "><a href="../internals/grammar.html"><strong aria-hidden="true">6.1.</strong> Grammar</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Gobba Programming Language Handbook</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#internals-of-the-gobba-programming-language" id="internals-of-the-gobba-programming-language">Internals of the Gobba programming language.</a></h1>
<h2><a class="header" href="#interactive-command-line-interface" id="interactive-command-line-interface">Interactive Command Line Interface</a></h2>
<p>If no filename is passed to <code>gobba</code> executable, the interactive shell interface is launched. The REPL shell is built upon a simple library called <a href="https://github.com/chrisnevers/ocamline">ocamline</a>, which itself relies on a library called <a href="https://github.com/ocaml-community/ocaml-linenoise">ocaml-linenoise</a> that provides <code>readline</code> navigation and completion functionality without additional system dependencies.</p>
<h2><a class="header" href="#syntax-and-parser" id="syntax-and-parser">Syntax and Parser</a></h2>
<p>Lexing is achieved with <code>ocamllex</code>, the default tool for generating scanners in OCaml. The parser is realized with the <a href="http://gallium.inria.fr/%7Efpottier/menhir/">Menhir</a> parser generator library, and is documented using <strong>Obelisk</strong>, which generates a clean text file containing the language grammar, available in Appendix [grammar].</p>
<h2><a class="header" href="#purity-inference" id="purity-inference">Purity Inference</a></h2>
<p>An important feature of the gobba language is the purity inference algorithm, which is performed statically on expressions before evaluation. It is an interpretation of expressions over the domain of purity, meant to prevent side effects by signal an error if they are contained inside the programs written in the language. Expressions are tagged by the algorithm with the <code>Pure</code>, <code>Impure</code> and <code>Numerical</code> labels. An <code>Impure</code> expression is an expression that contains calls to primitives that perform I/O operations, mutable variables and/or imperative style assignments. A <code>Numerical</code> expression is an expression where only numerical operations are performed; <code>Pure</code> expressions are those which do not fall into the previous two categories.</p>
<p>To achieve the execution of impure side effects, the programmer has two constructs available called <strong>purity blocks</strong>. By default, the evaluator is in an <code>Uncertain</code> context, which means that it will not allow side effects to be carried on by evaluation, but will allow evaluating purity blocks that change the currently allowed purity context. The <code>impure</code> statement takes an expression (the block) and evaluates it in a context where the allowed purity is <code>Impure</code>, so that side effects may be performed. The other construct available, the <code>pure</code> statement, takes an expression and enforces a <code>Pure</code> context, meaning that side effects and nested impure blocks will not be allowed inside of the expression.</p>
<h2><a class="header" href="#ast-optimization" id="ast-optimization">AST Optimization</a></h2>
<p>After purity inference is performed, and before evaluation, AST expressions are analyzed and optimized by an optimizer function that is recursively called over the tree that is representing the expression. The optimizer simplifies expressions which result is known and therefore does not need to be evaluated. For example, it is known that <code>5 + 3 equiv 8</code> and <code>true &amp;&amp; (true || (false &amp;&amp; false)) equiv true</code>. When a programmer writes a program, she or he may not want to do all the simple calculations before writing the program in which they appear in, we rely on machines to simplify those processes. Reducing constants before evaluation may seem unnecessary when writing a small program, but they do take away computation time, and if they appear inside of loops, it is a wise choice to simplify those constant expressions whose result is already known before it is calculated in all the loop iterations. It is also necessary in optimizing programs before compilation. The optimizer, by now, reduces operations between constants and <code>if</code> statements whose guard is always true (or false). To achieve minimization to an unreducible form, optimizer calls are repeated until it produces an output equal to its input; this way, we get a tree representing an expression that cannot be optimized again. This process is fairly easy:</p>
<pre><code class="language-ocaml">let rec iterate_optimizer e =
  let oe = optimize e in
  if oe = e then e (* Bottoms out *)
  else iterate_optimizer oe
</code></pre>
<p>Boolean operations are reduced using laws from the propositional calculus, such as DeMorgan’s law, complement, absorption and other trivial ones.</p>
<h2><a class="header" href="#types" id="types">Types</a></h2>
<p>TODO </p>
<h2><a class="header" href="#evaluator" id="evaluator">Evaluator</a></h2>
<p><code>gobba</code>’s evaluator is heavily inspired by the Metacircular Evaluator defined in the highly acclaimed textbook <a href="https://mitpress.mit.edu/sites/default/files/sicp/index.html">Structure and Interpretation of Computer Programs</a>.</p>
<h2><a class="header" href="#primitives" id="primitives">Primitives</a></h2>
<p>The language primitives that are implemented in OCaml are organized in modules separated by functionality. Each primitive is a function that accepts a list of evaluated values and returns a single reduced value; therefore they have a type of <code>evt list -&gt; evt</code>. OCaml primitives have to perform internal typechecking and unpacking of the arguments they receive from the gobba calls.</p>
<p>From the evaluator’s perspective, primitives are organized in a table such that when a symbol gets evaluated, it is looked up in the primitives table, if there is a match then the found primitive’s name is wrapped in an <code>ApplyPrimitive</code> expression nestedinside of a lazy lambda expression that permits partial application. When the evaluator finally encounters an <code>ApplyPrimitive</code> expression, the primitive OCaml function is extracted, applied to the arguments and the resulting value is returned by the current evaluator call. If a primitive is not found when looking up for a symbol, then a symbol lookup is performed in the current environment.</p>
<p>Some primitives, such as catamorphic procedures, are not native OCaml functions but small expressions written directly in gobba; those primitives are kept as lazy expressions into the same table as native OCaml primitives. The key difference between the two resides in the fact that those textual gobba primitives are not transformed into a function which body contains only an <code>ApplyPrimitive</code> call, but are instead parsed and analyzed at run time. The resulting additional startup time caused by parsing and analysis is proportional to the number of textual form primitives in the table and therefore quite irrelevant on non-embedded computer systems. The <em>fold left</em> and <em>fold right</em> catamorphic primitives are written directly in the gobba language and are hereby provided as examples.</p>
<p>This is the fold left procedure defined in the gobba standard library, which is tail recursive:</p>
<pre><code class="language-gobba">fun f z l -&gt;
if typeof l = &quot;list&quot; then
  let aux = fun f z l -&gt;
    if l = [] then z else
      aux f (f z (head l)) (tail l)
    in aux f z l
else if typeof l = &quot;dict&quot; then
    let aux = fun f z kl vl -&gt;
        if kl = [] &amp;&amp; vl = [] then z else
        aux f (f z (head vl)) (tail kl) (tail vl)
    in aux f z (getkeys l) (getvalues l)
else failwith &quot;value is not iterable&quot;
</code></pre>
<p>This is the fold right procedure defined in gobba standard library, which is <em>not</em> tail recursive:</p>
<pre><code class="language-gobba">fun f z l -&gt;
if typeof l = &quot;list&quot; then
   let aux = fun f z l -&gt;
      if l = [] then z else
      f (head l) (aux f z (tail l))
   in aux f z l
else if typeof l = &quot;dict&quot; then
   let aux = fun f z kl vl -&gt;
      if kl = [] &amp;&amp; vl = [] then z else
      f (head vl) (aux f z (tail kl) (tail vl))
   in aux f z (getkeys l) (getvalues l)
else failwith &quot;value is not iterable&quot;
</code></pre>
<h2><a class="header" href="#tests" id="tests">Tests</a></h2>
<p>Unit testing is extensively performed using the alcotest testing framework. Code coverage is provided by the <code>bisect_ppx</code> library which yields an HTML page containing the coverage percentage when unit tests are run by the dune build system. After each commit is pushed to the remote version control repository on Github, the package is built and tests are run thanks to the Travis Continuos Integration system.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../ocaml.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../internals/grammar.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../ocaml.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../internals/grammar.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
